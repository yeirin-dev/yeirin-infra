# Yeirin 인프라 아키텍처

## 전체 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Internet                                        │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
              ┌─────────────────────┴─────────────────────┐
              ▼                                           ▼
    ┌─────────────────┐                         ┌─────────────────┐
    │     Vercel      │                         │   AWS Cloud     │
    │  ┌───────────┐  │                         │                 │
    │  │  Next.js  │  │                         │  ┌───────────┐  │
    │  │ Frontend  │  │ ──── HTTPS ────────────▶│  │   Nginx   │  │
    │  └───────────┘  │                         │  │ (SSL/CORS)│  │
    └─────────────────┘                         │  └─────┬─────┘  │
                                                │        │        │
                                                │  ┌─────┴─────┐  │
                                                │  │           │  │
                                         ┌──────┼──┤  Docker   │  │
                                         │      │  │  Compose  │  │
                                         │      │  │           │  │
                                         │      │  └───────────┘  │
                                         │      └────────┬────────┘
                                         │               │
                     ┌───────────────────┼───────────────┼───────────────────┐
                     │                   │               │                   │
                     ▼                   ▼               ▼                   ▼
              ┌────────────┐      ┌────────────┐  ┌────────────┐      ┌────────────┐
              │   Yeirin   │      │ Yeirin AI  │  │   Soul-E   │      │ PostgreSQL │
              │    API     │      │  Service   │  │  Chatbot   │      │   Redis    │
              │  (NestJS)  │      │ (FastAPI)  │  │ (FastAPI)  │      │            │
              │   :3000    │      │   :8001    │  │   :8000    │      │   :5432    │
              └────────────┘      └────────────┘  └────────────┘      │   :6379    │
                     │                   │               │            └────────────┘
                     └───────────────────┴───────────────┴─────────────────┘
                                                │
                                                ▼
                                    ┌───────────────────────┐
                                    │    ECR (이미지 저장)   │
                                    └───────────────────────┘
```

## MSA 서비스 구성

### 1. Yeirin API Gateway (NestJS)
- **역할**: 메인 백엔드 API, 인증/인가 처리
- **포트**: 3000
- **주요 기능**:
  - 회원 관리 (보호자, 상담사, 기관 관리자)
  - 바우처 기관 관리
  - 상담 요청 관리
  - 파일 업로드 (S3)
  - JWT 기반 인증

### 2. Yeirin AI Service (FastAPI)
- **역할**: AI 기반 상담기관 추천
- **포트**: 8001
- **주요 기능**:
  - 상담의뢰지 분석
  - 협업 필터링 기반 추천
  - 상담기관 매칭

### 3. Soul-E Service (FastAPI)
- **역할**: LLM 기반 심리상담 챗봇
- **포트**: 8000
- **주요 기능**:
  - OpenAI GPT 기반 대화
  - 심리 검사 (KPRC)
  - 상담의뢰지 자동 생성
  - SSE 스트리밍

## 네트워크 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                         VPC (10.0.0.0/16)                   │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │              Public Subnet (10.0.1.0/24)            │   │
│   │                                                     │   │
│   │   ┌─────────────────────────────────────────────┐   │   │
│   │   │              EC2 Instance                   │   │   │
│   │   │                                             │   │   │
│   │   │   ┌──────────────────────────────────────┐  │   │   │
│   │   │   │         Docker Network               │  │   │   │
│   │   │   │        (yeirin-network)              │  │   │   │
│   │   │   │                                      │  │   │   │
│   │   │   │  nginx ──▶ api-gateway ──▶ postgres  │  │   │   │
│   │   │   │    │                         ▲       │  │   │   │
│   │   │   │    ├──▶ yeirin-ai ──────────┤       │  │   │   │
│   │   │   │    │                         │       │  │   │   │
│   │   │   │    └──▶ soul-e ─────────────┘       │  │   │   │
│   │   │   │              │                       │  │   │   │
│   │   │   │              └──▶ redis              │  │   │   │
│   │   │   └──────────────────────────────────────┘  │   │   │
│   │   │                                             │   │   │
│   │   │   Security Groups:                          │   │   │
│   │   │   - nginx-sg: 80, 443, 22(제한)             │   │   │
│   │   │   - backend-sg: 3000, 8000, 8001 (내부)     │   │   │
│   │   └─────────────────────────────────────────────┘   │   │
│   │                                                     │   │
│   └─────────────────────────────────────────────────────┘   │
│                              │                              │
│                              ▼                              │
│                    Internet Gateway (무료)                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 보안 그룹 설정

### Nginx Security Group (nginx-sg)
| 방향 | 프로토콜 | 포트 | 소스 | 설명 |
|------|---------|------|------|------|
| Inbound | TCP | 80 | 0.0.0.0/0 | HTTP (Let's Encrypt) |
| Inbound | TCP | 443 | 0.0.0.0/0 | HTTPS |
| Inbound | TCP | 22 | 관리자 IP | SSH |
| Outbound | ALL | ALL | 0.0.0.0/0 | 모든 아웃바운드 |

### Backend Security Group (backend-sg)
| 방향 | 프로토콜 | 포트 | 소스 | 설명 |
|------|---------|------|------|------|
| Inbound | TCP | 3000 | nginx-sg | Yeirin API |
| Inbound | TCP | 8001 | nginx-sg | Yeirin AI |
| Inbound | TCP | 8000 | nginx-sg | Soul-E |
| Inbound | ALL | ALL | self | 내부 통신 |
| Outbound | ALL | ALL | 0.0.0.0/0 | 모든 아웃바운드 |

## 데이터 흐름

### 1. 사용자 인증 흐름
```
Vercel → Nginx → Yeirin API (:3000) → PostgreSQL
                      │
                      └── JWT 발급 → Vercel (localStorage)
```

### 2. 심리상담 (Soul-E) 흐름
```
Vercel → Nginx → Soul-E (:8000) → OpenAI API
                      │                │
                      └── 세션 저장 ──→ PostgreSQL
                      │
                      └── SSE 스트리밍 → Vercel
```

### 3. AI 추천 흐름
```
Vercel → Nginx → Yeirin AI (:8001) → 추천 알고리즘
                      │                   │
                      └── 결과 저장 ─────→ PostgreSQL
```

## 배포 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                      GitHub Repository                       │
│                                                             │
│   develop branch ───────────────────▶ main branch           │
│         │                                   │               │
│         ▼                                   ▼               │
│   ┌───────────┐                       ┌───────────┐        │
│   │  GitHub   │                       │  GitHub   │        │
│   │  Actions  │                       │  Actions  │        │
│   │   (Dev)   │                       │  (Prod)   │        │
│   └─────┬─────┘                       └─────┬─────┘        │
│         │                                   │               │
└─────────┼───────────────────────────────────┼───────────────┘
          │                                   │
          ▼                                   ▼
    ┌───────────┐                       ┌───────────┐
    │   Build   │                       │   Build   │
    │   Docker  │                       │   Docker  │
    │   Images  │                       │   Images  │
    └─────┬─────┘                       └─────┬─────┘
          │                                   │
          ▼                                   ▼
    ┌───────────┐                       ┌───────────┐
    │    ECR    │                       │    ECR    │
    │ dev-latest│                       │   latest  │
    │  :sha     │                       │  :sha     │
    └─────┬─────┘                       └─────┬─────┘
          │                                   │
          ▼                                   ▼
    ┌───────────┐                       ┌───────────┐
    │  EC2 Dev  │                       │ EC2 Prod  │
    │  t3.small │                       │ t3.medium │
    └───────────┘                       └───────────┘
```

## 확장 전략

### Phase 1: 현재 (MVP)
- 단일 EC2 인스턴스
- Docker Compose
- 수동 스케일업

### Phase 2: 성장기
- 서비스별 EC2 분리
- RDS PostgreSQL
- ElastiCache Redis
- Application Load Balancer

### Phase 3: 스케일
- ECS/EKS 마이그레이션
- Auto Scaling
- Multi-AZ 구성
- CloudFront CDN

## 모니터링

### CloudWatch 메트릭
- CPU/Memory 사용률
- 디스크 사용량
- 네트워크 I/O

### 로그 관리
- 애플리케이션 로그 → CloudWatch Logs
- Nginx 액세스/에러 로그
- Docker 컨테이너 로그

### 알림
- Slack Webhook 연동
- CPU 80% 초과 시 알림
- 헬스체크 실패 시 알림
